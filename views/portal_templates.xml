<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="portal_invoice_page_inherit" inherit_id="account.portal_invoice_page" name="Invoice Portal Boleto Inter">
        <xpath expr="//div[@id='invoice_content']" position="inside">
            <t t-set="inter_txs" t-value="invoice.transaction_ids.filtered(lambda t: t.acquirer_id.provider == 'apiboletointer' and t.state not in ['cancel', 'error', 'done'])"/>
            <t t-if="inter_txs">
                <div id="pix_payment_box" class="mb-4 border rounded overflow-hidden shadow-sm" style="border-color: #dee2e6 !important;">
                    <div class="bg-primary text-white p-2 px-3 d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fa fa-qrcode mr-2"></i>Pague agora via PIX (Banco Inter)</h6>
                        <span class="badge badge-light text-primary small">Aprovação Imediata</span>
                    </div>
                    <div class="p-3 bg-white">
                        <t t-foreach="inter_txs" t-as="tx">
                            <div class="row align-items-center no-gutters">
                                <div class="col-auto mr-3">
                                    <t t-if="tx.boleto_pix_code">
                                        <img t-att-src="'/report/barcode/?type=QR&amp;value=%s&amp;width=120&amp;height=120' % tx.boleto_pix_code"
                                             alt="QR Code PIX"
                                             class="img-fluid border bg-white"
                                             style="max-width: 100px;"/>
                                    </t>
                                    <t t-else="">
                                        <div class="text-warning small text-center border p-2" style="width: 100px;">QR Code Indisponível</div>
                                    </t>
                                </div>
                                <div class="col">
                                    <div class="d-flex flex-wrap justify-content-between align-items-baseline mb-1">
                                        <span class="font-weight-bold text-dark small">Vencimento: <span t-field="tx.date_maturity"/></span>
                                        <span class="h5 font-weight-bold text-primary mb-0"><span t-field="tx.amount" t-options='{"widget": "monetary", "display_currency": tx.currency_id}'/></span>
                                    </div>
                                    
                                    <t t-if="tx.boleto_pix_code">
                                        <div class="input-group input-group-sm">
                                            <input type="text" class="form-control form-control-sm border-right-0 bg-light" t-att-value="tx.boleto_pix_code" readonly="readonly" t-att-id="'pix-code-%s' % tx.id" style="font-family: monospace; font-size: 0.7rem;"/>
                                            <div class="input-group-append">
                                                <button class="btn btn-primary btn-sm" type="button" t-att-onclick="'var copyText = document.getElementById(\'pix-code-%s\'); copyText.select(); document.execCommand(\'copy\'); alert(\'Código PIX copiado!\');' % tx.id">
                                                    <i class="fa fa-copy"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </t>
                                    
                                    <div class="mt-2 d-flex justify-content-between align-items-center">
                                        <small class="text-muted" t-if="tx.acquirer_reference">Ref: <span t-field="tx.acquirer_reference"/></small>
                                        <a t-if="tx.acquirer_reference" class="btn btn-link btn-sm p-0 text-info font-weight-bold" t-att-href="'/boleto/inter/pdf/%s' % tx.id" target="_blank" style="font-size: 0.75rem;">
                                            <i class="fa fa-file-pdf-o"></i> Baixar Boleto PDF
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <hr t-if="not tx_last" class="my-2"/>
                        </t>
                    </div>
                </div>
                <script type="text/javascript">
                    document.addEventListener("DOMContentLoaded", function() {
                        var pixBox = document.getElementById('pix_payment_box');
                        var container = document.getElementById('invoice_content');
                        if (pixBox &amp;&amp; container) {
                            container.prepend(pixBox);
                        }
                        
                        // Ocultar mensagem padrão de "aguardando aprovação" do Odoo
                        // Esta mensagem costuma confundir o usuário em boletos/pix
                        var alerts = document.querySelectorAll('.alert.alert-info, .alert.alert-warning');
                        alerts.forEach(function(alert) {
                            if (alert.textContent.includes("aguardando por aprovação") || alert.textContent.includes("waiting for approval")) {
                                alert.style.display = 'none';
                            }
                        });
                    });
                </script>
            </t>
        </xpath>
    </template>
</odoo>
